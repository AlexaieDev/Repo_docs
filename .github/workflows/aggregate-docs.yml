name: Agregar y Desplegar Documentaci√≥n

on:
  # Trigger cuando se recibe un evento desde un proyecto
  repository_dispatch:
    types: [docs_updated]

  # Trigger cuando se actualiza cualquier rama docs/*
  push:
    branches:
      - 'docs/**'

  # Permitir ejecuci√≥n manual
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Reconstruir toda la documentaci√≥n'
        required: false
        default: 'false'
        type: boolean

  # Ejecutar peri√≥dicamente para mantener actualizado
  schedule:
    - cron: '0 2 * * *'  # Diariamente a las 2 AM

env:
  PYTHON_VERSION: '3.10'

jobs:
  aggregate-documentation:
    name: Agregar Documentaci√≥n de Proyectos
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repositorio principal
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para obtener todas las ramas

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Instalar dependencias del agregador
        run: |
          pip install --upgrade pip
          pip install pyyaml mkdocs mkdocs-material mkdocs-material-extensions
          pip install jsonschema markdown pygments

      - name: Buscar y fetch todas las ramas docs/*
        run: |
          echo "üì• Obteniendo todas las ramas de documentaci√≥n..."

          # Fetch todas las ramas remotas
          git fetch --all

          # Listar ramas docs/*
          echo "üìã Ramas de documentaci√≥n encontradas:"
          git branch -r | grep "origin/docs/" || echo "No se encontraron ramas docs/*"

      - name: Ejecutar agregador de documentaci√≥n
        run: |
          echo "üîÑ Ejecutando agregador de documentaci√≥n..."
          python scripts/aggregate_docs.py --mode branches --verbose
        continue-on-error: true

      - name: Verificar resultado de agregaci√≥n
        run: |
          if [ -f "docs/mkdocs.yml" ]; then
            echo "‚úÖ Configuraci√≥n MkDocs generada exitosamente"
            echo "üìã Contenido de mkdocs.yml:"
            head -50 docs/mkdocs.yml
          else
            echo "‚ùå No se gener√≥ mkdocs.yml"
            exit 1
          fi

      - name: Validar estructura de documentaci√≥n
        run: |
          echo "üîç Validando estructura de documentaci√≥n..."

          # Verificar que existe la carpeta de proyectos
          if [ -d "docs/docs/proyectos" ]; then
            echo "‚úÖ Carpeta de proyectos existe"
            echo "üìÅ Proyectos encontrados:"
            ls -la docs/docs/proyectos/
          else
            echo "‚ö†Ô∏è No se encontr√≥ carpeta de proyectos"
          fi

      - name: Construir sitio MkDocs
        run: |
          cd docs
          echo "üèóÔ∏è Construyendo sitio MkDocs..."
          mkdocs build --strict --verbose
        continue-on-error: false

      - name: Crear archivo .nojekyll
        run: |
          touch docs/site/.nojekyll
          echo "üìÑ Archivo .nojekyll creado para GitHub Pages"

      - name: Generar reporte de documentaci√≥n
        run: |
          cat > docs/site/build-info.json <<EOF
          {
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "triggered_by": "${{ github.event_name }}",
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}"
          }
          EOF

          echo "üìä Informaci√≥n de build guardada"

      - name: Deploy a GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/site
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'üöÄ Desplegar documentaci√≥n agregada - ${{ github.sha }}'

      - name: Crear resumen de ejecuci√≥n
        if: always()
        run: |
          echo "## üìö Resumen de Agregaci√≥n de Documentaci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs/docs/proyectos" ]; then
            project_count=$(find docs/docs/proyectos -maxdepth 1 -type d | wc -l)
            echo "‚úÖ **Proyectos procesados:** $((project_count - 1))" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **No se encontraron proyectos**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Detalles" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "- **Proyecto actualizado:** ${{ github.event.client_payload.repository }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Enlaces" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver sitio de documentaci√≥n](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver logs de build](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  notify-update:
    name: Notificar Actualizaci√≥n
    needs: aggregate-documentation
    if: success() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Enviar notificaci√≥n de √©xito
        run: |
          echo "‚úÖ Documentaci√≥n actualizada y desplegada exitosamente"

          # Aqu√≠ puedes agregar integraciones con Slack, Discord, etc.
          # Ejemplo con webhook de Discord:
          # curl -H "Content-Type: application/json" \
          #      -X POST \
          #      -d '{"content":"üìö Documentaci√≥n actualizada exitosamente"}' \
          #      ${{ secrets.DISCORD_WEBHOOK_URL }}

  cleanup-old-branches:
    name: Limpiar Ramas Antiguas de Documentaci√≥n
    needs: aggregate-documentation
    if: github.event_name == 'schedule'  # Solo en ejecuciones programadas
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Limpiar ramas docs/* antiguas
        run: |
          echo "üßπ Buscando ramas de documentaci√≥n antiguas (>30 d√≠as)..."

          # Fecha l√≠mite (30 d√≠as atr√°s)
          LIMIT_DATE=$(date -d "30 days ago" +%s)

          # Buscar y eliminar ramas antiguas
          git branch -r | grep "origin/docs/" | while read branch; do
            branch_name=${branch#origin/}
            last_commit_date=$(git log -1 --format=%ct origin/$branch_name)

            if [ "$last_commit_date" -lt "$LIMIT_DATE" ]; then
              echo "Eliminando rama antigua: $branch_name"
              git push origin --delete $branch_name || true
            fi
          done

          echo "‚úÖ Limpieza completada"